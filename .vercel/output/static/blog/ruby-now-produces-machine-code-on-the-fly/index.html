<!DOCTYPE html><html lang="en" class="selection:text-on-primary h-full min-h-0 text-base selection:bg-primary/25 sm:text-lg scroll-pt-nav-height scroll-smooth sm:scroll-pt-0"> <head> <!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v4.3.3"><!-- Font preloads --><link rel="preload" href="/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin><link rel="preload" href="/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://example.com/blog/ruby-now-produces-machine-code-on-the-fly/"><!-- Primary Meta Tags --><title>Ruby now produces machine code on-the-fly</title><meta name="title" content="Ruby now produces machine code on-the-fly"><meta name="description" content="A primer on how YJIT Ruby's new JIT compiler works, as well as a deep dive into improvements to the Ruby GC and memory layout."><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://example.com/blog/ruby-now-produces-machine-code-on-the-fly/"><meta property="og:title" content="Ruby now produces machine code on-the-fly"><meta property="og:description" content="A primer on how YJIT Ruby's new JIT compiler works, as well as a deep dive into improvements to the Ruby GC and memory layout."><meta property="og:image" content="https://example.com/_astro/yjit.u3rZapDH.png"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://example.com/blog/ruby-now-produces-machine-code-on-the-fly/"><meta property="twitter:title" content="Ruby now produces machine code on-the-fly"><meta property="twitter:description" content="A primer on how YJIT Ruby's new JIT compiler works, as well as a deep dive into improvements to the Ruby GC and memory layout."><meta property="twitter:image" content="https://example.com/_astro/yjit.u3rZapDH.png"><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"> <link rel="stylesheet" href="/_astro/_slug_.fPnpziMM.css" />
<link rel="stylesheet" href="/_astro/_slug_.iYS_UISD.css" />
<style>dialog.svelte-fu0dbb.svelte-fu0dbb{z-index:1;--tw-bg-opacity:1;background-color:rgba(240,243,255,var(--tw-bg-opacity));transition-property:all;transition-timing-function:cubic-bezier(.23,1,.32,1);transition-delay:.15s;transition-duration:.3s;transition-timing-function:cubic-bezier(.4,0,.2,1)}@supports (color: color(display-p3 0 0 0)){dialog.svelte-fu0dbb.svelte-fu0dbb{background-color:color(display-p3 .94177 .95165 .99851 / var(--tw-bg-opacity))}}@supports (color: oklab(0% 0 0)){dialog.svelte-fu0dbb.svelte-fu0dbb{background-color:oklch(.964844 .01775 275 / var(--tw-bg-opacity))}}dialog.svelte-fu0dbb.svelte-fu0dbb::backdrop{transition:backdrop .5s ease-in-out;background:#0000004d}dialog[open].svelte-fu0dbb.svelte-fu0dbb{--tw-bg-opacity:1;background-color:rgba(250,251,254,var(--tw-bg-opacity))}@supports (color: oklab(0% 0 0)){dialog[open].svelte-fu0dbb.svelte-fu0dbb{background-color:oklch(.988281 .0046875 275 / var(--tw-bg-opacity))}}dialog.svelte-fu0dbb img.svelte-fu0dbb{margin-bottom:1rem}
</style><script type="module" src="/_astro/hoisted.rNJk9NOy.js"></script></head> <body>  <header class="grid grid-cols-layout antialiased" data-astro-cid-3ef6ksr2> <nav class="h-nav-height sm:col-content" data-astro-cid-3ef6ksr2> <h2 data-astro-cid-3ef6ksr2> <a href="/" data-astro-cid-3ef6ksr2>Aaron&#39;s Dev Blog</a> </h2> <div class="internal-links select-none" data-astro-cid-3ef6ksr2> <a href="/" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> Home </a>  <a href="/blog/1" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> Blog </a>  <a href="/tags" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> Tags </a>  <a href="/about" data-astro-cid-3ef6ksr2 data-astro-cid-eimmu3lg> About </a>  </div> <div class="social-links select-none" data-astro-cid-3ef6ksr2> <a href="https://linkedin.com/in/aaronlifton" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>Are you a recruiter? Connect with Aaron on LinkedIn</span> <svg width="32" height="32" viewBox="0 0 24 24" data-astro-cid-3ef6ksr2 data-icon="linkedin">  <symbol id="ai:local:linkedin"><path fill="currentColor" d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></symbol> <use  xlink:href="#ai:local:linkedin"></use> </svg> </a> <a href="https://github.com/aaronlifton" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>Go to Aaron's GitHub repo</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-3ef6ksr2></path></svg> </a> </div> </nav> </header>   <main> <div class="px-0 sm:col-content">    <article class="prose">  <div data-blog-post-container data-toc="[object Object]" class="group flex flex-col lg:flex-row-reverse lg:gap-8 lg:flex-row-reverse" data-astro-cid-bvzihdzo> <aside style="--offset-from-top:1rem" class="relative shrink-0 mb-0 lg:mb-8 lg:ml-auto lg:mb-0 lg:basis-1/3 lg:sticky lg:top-[var(--offset-from-top)] lg:h-[calc(100vh-var(--offset-from-top)_*_2)] [&#38;_h2]:m-0 max-w-prose" data-astro-cid-bvzihdzo> <button type="button" data-toggle-toc="true" data-open-toc-label="Open ToC" data-closed-toc-label="Close ToC" aria-label="Close Table of Contents" style="--duration:150ms" data-preload="true" data-astro-cid-bvzihdzo="true" class="bg-surface hover:bg-hover text-on-background disabled:bg-disabled disabled:text-on-disabled disabled:hover:cursor-not-allowed disabled:hover:bg-disabled hover:text-primary min-w-[40px] h-[40px] justify-center items-center rounded-full z-1 absolute top-4 right-4 hidden lg:grid lg:min-w-0 lg:group-data-toc-open:grid-cols-[0fr_max-content] lg:group-data-toc-closed:grid-cols-[1fr_max-content] transition-all duration-[var(--duration)] ease-in-out overflow-hidden lg:justify-center p-6"> <svg width="1em" height="1em" viewBox="0 0 24 24" class="col-start-2 col-end-2 row-start-1 row-end-1 scale-0 transition-transform duration-[var(--duration)] ease-out group-data-toc-open:scale-100 group-data-toc-open:delay-[var(--duration)] fill-slate-100 border-md border-2 text-slate-400 bg-slate-200 text-slate-600" data-astro-cid-bvzihdzo data-icon="tabler/x">  <symbol id="ai:local:tabler/x"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"><path stroke="none" d="M0 0h24v24H0z"/><path d="M18 6 6 18M6 6l12 12"/></g></symbol> <use  xlink:href="#ai:local:tabler/x"></use> </svg> <svg width="1em" height="1em" viewBox="0 0 24 24" class="col-start-2 col-end-2 row-start-1 row-end-1 scale-0 transition-transform duration-[var(--duration)] ease-in group-data-toc-closed:scale-100 group-data-toc-closed:delay-[var(--duration)" data-astro-cid-bvzihdzo data-icon="tabler/list">  <symbol id="ai:local:tabler/list"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"><path stroke="none" d="M0 0h24v24H0z"/><path d="M9 6h11M9 12h11M9 18h11M5 6v.01M5 12v.01M5 18v.01"/></g></symbol> <use  xlink:href="#ai:local:tabler/list"></use> </svg> <div class="col-start-1 col-end-1 group-data-toc-closed:mx-2 truncate" data-astro-cid-bvzihdzo>
Open ToC
</div> </button> <div data-blog-post-toc-container data-preload class="lg:h-full lg:p-4 lg:ml-auto lg:group-data-toc-open:translate-x-0 lg:group-data-toc-open:scale-x-1 lg:group-data-toc-open:opacity-1 lg:group-data-toc-closed:translate-x-full lg:group-data-toc-closed:opacity-0 lg:group-data-toc-closed:scale-x-0 lg:group-data-toc-closed:pointer-events-none transition-[transform,opacity] duration-300 ease-in-out" data-astro-cid-bvzihdzo> <div class="hidden bg-slate-50 p-4 lg:flex lg:h-full lg:flex-col" data-astro-cid-obewoz47> <div class="flex items-center gap-2 h-10 flex-none" data-astro-cid-obewoz47> <svg width="1em" height="1em" viewBox="0 0 24 24" data-astro-cid-obewoz47 data-icon="tabler/list">   <use  xlink:href="#ai:local:tabler/list"></use> </svg> <b class="m-0" data-astro-cid-obewoz47>Table of contents</b> <div class="ml-auto flex items-center transition-transform duration-150 ease-in group-open:rotate-180 lg:hidden" data-astro-cid-obewoz47> <svg width="1em" height="1em" viewBox="0 0 24 24" data-astro-cid-obewoz47 data-icon="tabler/chevron-down">  <symbol id="ai:local:tabler/chevron-down"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"><path stroke="none" d="M0 0h24v24H0z"/><path d="m6 9 6 6 6-6"/></g></symbol> <use  xlink:href="#ai:local:tabler/chevron-down"></use> </svg> </div> </div> <!-- <TOCProgress client:load /> --> <nav data-toc-wrapper class="not-prose pt-4 h-auto min-h-0 lg:overflow-y-auto leading-6 [&#38;_a_*]:indent-0 [&#38;_ol]:m-0 [&#38;_ol]:list-none [&#38;_ol]:pl-4 [&#38;_ol_li]:my-4 [&#38;_ol_li[data-active]>a]:text-primary [&#38;_ol_li[data-active]>a:first-of-type]:text-zinc-800 [&#38;_ol_li[data-active]>a:first-of-type]:text-bold [&#38;_ol_li[data-active]]>a:text-zinc-800 [&#38;_ol_li]:relative [&#38;_ol_li_a:hover]:bg-hover [&#38;_ol_li_a]:block [&#38;_ol_li_a]:border-b-0 [&#38;_ol_li_a]:transition-colors [&#38;_ol_li_a]:duration-150 [&#38;_ol_ol]:pl-8 [&#38;_ol_ol_ol]:pl-12 [&#38;_ol_ol_ol_ol]:pl-16 [&#38;_ol_li_a]:text-zinc-300 [&#38;_ol_li_a]:text-[rgb(99, 102, 241)] [&#38;_ol_li_a]:no-underline [&#38;_ol_li_a:hover:first-of-type]:text-zinc-800 [&#38;_ol_li[data-active]_a:hover:first-of-type]:text-zinc-800 flex flex-row" data-astro-cid-obewoz47> <style>astro-island,astro-slot,astro-static-slot{display:contents}</style><script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).load=e;window.dispatchEvent(new Event("astro:load"));})();;(()=>{var b=Object.defineProperty;var f=(c,o,i)=>o in c?b(c,o,{enumerable:!0,configurable:!0,writable:!0,value:i}):c[o]=i;var l=(c,o,i)=>(f(c,typeof o!="symbol"?o+"":o,i),i);var p;{let c={0:t=>m(t),1:t=>i(t),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(i(t)),5:t=>new Set(i(t)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(t),9:t=>new Uint16Array(t),10:t=>new Uint32Array(t)},o=t=>{let[e,r]=t;return e in c?c[e](r):void 0},i=t=>t.map(o),m=t=>typeof t!="object"||t===null?t:Object.fromEntries(Object.entries(t).map(([e,r])=>[e,o(r)]));customElements.get("astro-island")||customElements.define("astro-island",(p=class extends HTMLElement{constructor(){super(...arguments);l(this,"Component");l(this,"hydrator");l(this,"hydrate",async()=>{var d;if(!this.hydrator||!this.isConnected)return;let e=(d=this.parentElement)==null?void 0:d.closest("astro-island[ssr]");if(e){e.addEventListener("astro:hydrate",this.hydrate,{once:!0});return}let r=this.querySelectorAll("astro-slot"),a={},h=this.querySelectorAll("template[data-astro-template]");for(let n of h){let s=n.closest(this.tagName);s!=null&&s.isSameNode(this)&&(a[n.getAttribute("data-astro-template")||"default"]=n.innerHTML,n.remove())}for(let n of r){let s=n.closest(this.tagName);s!=null&&s.isSameNode(this)&&(a[n.getAttribute("name")||"default"]=n.innerHTML)}let u;try{u=this.hasAttribute("props")?m(JSON.parse(this.getAttribute("props"))):{}}catch(n){let s=this.getAttribute("component-url")||"<unknown>",y=this.getAttribute("component-export");throw y&&(s+=` (export ${y})`),console.error(`[hydrate] Error parsing props for component ${s}`,this.getAttribute("props"),n),n}await this.hydrator(this)(this.Component,u,a,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),this.dispatchEvent(new CustomEvent("astro:hydrate"))});l(this,"unmount",()=>{this.isConnected||this.dispatchEvent(new CustomEvent("astro:unmount"))})}disconnectedCallback(){document.removeEventListener("astro:after-swap",this.unmount),document.addEventListener("astro:after-swap",this.unmount,{once:!0})}connectedCallback(){if(!this.hasAttribute("await-children")||document.readyState==="interactive"||document.readyState==="complete")this.childrenConnectedCallback();else{let e=()=>{document.removeEventListener("DOMContentLoaded",e),r.disconnect(),this.childrenConnectedCallback()},r=new MutationObserver(()=>{var a;((a=this.lastChild)==null?void 0:a.nodeType)===Node.COMMENT_NODE&&this.lastChild.nodeValue==="astro:end"&&(this.lastChild.remove(),e())});r.observe(this,{childList:!0}),document.addEventListener("DOMContentLoaded",e)}}async childrenConnectedCallback(){let e=this.getAttribute("before-hydration-url");e&&await import(e),this.start()}start(){let e=JSON.parse(this.getAttribute("opts")),r=this.getAttribute("client");if(Astro[r]===void 0){window.addEventListener(`astro:${r}`,()=>this.start(),{once:!0});return}Astro[r](async()=>{let a=this.getAttribute("renderer-url"),[h,{default:u}]=await Promise.all([import(this.getAttribute("component-url")),a?import(a):()=>()=>{}]),d=this.getAttribute("component-export")||"default";if(!d.includes("."))this.Component=h[d];else{this.Component=h;for(let n of d.split("."))this.Component=this.Component[n]}return this.hydrator=u,this.hydrate},e,this)}attributeChangedCallback(){this.hydrate()}},l(p,"observedAttributes",["props"]),p))}})();</script><astro-island uid="12Xfyy" prefix="r1" component-url="/_astro/TOCIndicator.jDhRNJmh.js" component-export="default" renderer-url="/_astro/client.mYTtLqQB.js" props="{&quot;data-astro-cid-obewoz47&quot;:[0,true]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;TOCScroll&quot;,&quot;value&quot;:true}" await-children=""><div class="_wrapper_1fgdy_10"><div class="_container_1fgdy_16"><div class="_item_1fgdy_23" style="will-change:transform"></div></div></div><!--astro:end--></astro-island> <ol data-astro-toc="1"><li data-astro-toc="1"> <a href="#ruby-now-produces-machine-code-on-the-fly">Ruby now produces machine code on-the-fly</a> <ol data-astro-toc="2"><li data-astro-toc="2"> <a href="#understanding-yjit-in-ruby">Understanding YJIT in Ruby</a>  </li><li data-astro-toc="2"> <a href="#basic-block-versioning-bbv-and-yjit">Basic Block Versioning (BBV) and YJIT</a>  </li><li data-astro-toc="2"> <a href="#shopifys-influential-contributions">Shopify’s Influential Contributions</a>  </li><li data-astro-toc="2"> <a href="#embracing-the-future-with-yjit">Embracing the Future with YJIT</a>  </li></ol> </li></ol> </nav> </div> <details class="group px-horizontal-padding py-4 lg:hidden" aria-label="Table of contents" data-astro-cid-obewoz47> <summary class="list-none" data-astro-cid-obewoz47> <div class="align-center flex items-center gap-2" data-astro-cid-obewoz47> <svg width="1em" height="1em" viewBox="0 0 24 24" data-astro-cid-obewoz47 data-icon="tabler/list">   <use  xlink:href="#ai:local:tabler/list"></use> </svg> <h2 class="m-0" data-astro-cid-obewoz47>Table of contents</h2> <div class="ml-auto flex items-center transition-transform duration-150 ease-in group-open:rotate-180 lg:hidden" data-astro-cid-obewoz47> <svg width="1em" height="1em" viewBox="0 0 24 24" data-astro-cid-obewoz47 data-icon="tabler/chevron-down">   <use  xlink:href="#ai:local:tabler/chevron-down"></use> </svg> </div> </div> </summary> <nav data-toc-wrapper class="mt-4 [&#38;_ol]:m-0 [&#38;_ol]:list-outside [&#38;_ol]:px-horizontal-padding [&#38;_ol_li:not(:first-child)]:mt-1" data-astro-cid-obewoz47> <ol data-astro-toc="1"><li data-astro-toc="1"> <a href="#ruby-now-produces-machine-code-on-the-fly">Ruby now produces machine code on-the-fly</a> <ol data-astro-toc="2"><li data-astro-toc="2"> <a href="#understanding-yjit-in-ruby">Understanding YJIT in Ruby</a>  </li><li data-astro-toc="2"> <a href="#basic-block-versioning-bbv-and-yjit">Basic Block Versioning (BBV) and YJIT</a>  </li><li data-astro-toc="2"> <a href="#shopifys-influential-contributions">Shopify’s Influential Contributions</a>  </li><li data-astro-toc="2"> <a href="#embracing-the-future-with-yjit">Embracing the Future with YJIT</a>  </li></ol> </li></ol> </nav> </details>   </div> </aside> <!-- /** min-w-0 [&>pre]:my-8 [&>pre]:max-sm:full-bleed [&>[data-codeblock]]:my-8 --> <!-- [&>[data-codeblock]]:max-sm:full-bleed [&>[data-codeblock]_pre]:max-sm:rounded-none --> <div data-blog-post class="min-w-0" data-astro-cid-bvzihdzo> <div class="hero-image" data-astro-cid-bvzihdzo>  <div class="tags w-full max-w-xl mx-auto flex center justify-center" data-astro-cid-pjkakwps> <span class="tag mr-1" data-astro-cid-pjkakwps> <a href="/tags/ruby" data-astro-cid-pjkakwps> <svg width="1em" height="1em" viewBox="0 0 24 24" class="stroke-primary fill-theme-primary" data-astro-cid-pjkakwps data-icon="ruby">  <symbol id="ai:local:ruby"><path fill="currentColor" d="M20.156.083c3.033.525 3.893 2.598 3.829 4.77L24 4.822 22.635 22.71 4.89 23.926h.016C3.433 23.864.15 23.729 0 19.139l1.645-3 2.819 6.586.503 1.172 2.805-9.144-.03.007.016-.03 9.255 2.956-1.396-5.431-.99-3.9 8.82-.569-.615-.51L16.5 2.114 20.159.073l-.003.01zM0 19.089zM5.13 5.073c3.561-3.533 8.157-5.621 9.922-3.84 1.762 1.777-.105 6.105-3.673 9.636-3.563 3.532-8.103 5.734-9.864 3.957-1.766-1.777.045-6.217 3.612-9.75l.003-.003z"/></symbol> <use  xlink:href="#ai:local:ruby"></use> </svg> ruby </a> ,  </span><span class="tag mr-1" data-astro-cid-pjkakwps> <a href="/tags/rails" data-astro-cid-pjkakwps> <svg width="1em" height="1em" viewBox="0 0 24 24" class="stroke-primary fill-theme-primary" data-astro-cid-pjkakwps data-icon="rails">  <symbol id="ai:local:rails"><path fill="currentColor" d="M.741 19.365h8.36s-1.598-7.291 3.693-10.243l.134-.066c1.286-.637 4.907-2.431 10.702 1.854.19-.159.37-.286.37-.286s-5.503-5.492-11.63-4.878c-3.079.275-6.867 3.079-9.09 6.783C1.058 16.233.741 19.365.741 19.365Zm8.804-.783a10.682 10.682 0 0 1-.127-1.333l1.143.412c.063.498.159.963.254 1.376l-1.27-.455Zm-7.799-4.317L.529 13.82c-.201.455-.423.984-.529 1.27l1.217.444c.137-.359.36-.878.529-1.269Zm7.831.296.857.677c.042-.413.116-.825.222-1.238l-.762-.603c-.137.391-.233.783-.317 1.164Zm2.042-2.646-.508-.762c.191-.243.413-.486.656-.709l.476.72a5.958 5.958 0 0 0-.624.751ZM4.19 8.878l.752.656c-.254.265-.498.551-.72.836l-.815-.698c.244-.265.508-.529.783-.794Zm9.799 1.027-.243-.73c.265-.117.571-.233.931-.339l.233.698a6.82 6.82 0 0 0-.921.371Zm3.122-.656.042-.667c.339.021.688.064 1.048.138l-.042.656a5.859 5.859 0 0 0-1.048-.127ZM8.942 6.392l-.476-.731c-.265.138-.54.286-.826.455l.487.741c.275-.169.54-.328.815-.465Zm9.217-.053.042-.709c-.095-.053-.36-.18-1.026-.371l-.043.699c.349.116.688.243 1.027.381ZM13.238 5.28h.106l-.212-.645c-.328 0-.666.021-1.016.063l.201.625a8.87 8.87 0 0 1 .921-.043Z"/></symbol> <use  xlink:href="#ai:local:rails"></use> </svg> rails </a> ,  </span><span class="tag mr-1" data-astro-cid-pjkakwps> <a href="/tags/performance" data-astro-cid-pjkakwps> <svg width="1em" height="1em" viewBox="0 0 24 24" class="stroke-primary fill-theme-primary" data-astro-cid-pjkakwps data-icon="tabler/rocket">  <symbol id="ai:local:tabler/rocket"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"><path stroke="none" d="M0 0h24v24H0z"/><path d="M4 13a8 8 0 0 1 7 7 6 6 0 0 0 3-5 9 9 0 0 0 6-8 3 3 0 0 0-3-3 9 9 0 0 0-8 6 6 6 0 0 0-5 3"/><path d="M7 14a6 6 0 0 0-3 6 6 6 0 0 0 6-3m4-8a1 1 0 1 0 2 0 1 1 0 1 0-2 0"/></g></symbol> <use  xlink:href="#ai:local:tabler/rocket"></use> </svg> performance </a> ,  </span><span class="tag mr-1" data-astro-cid-pjkakwps> <a href="/tags/compilers" data-astro-cid-pjkakwps> <svg width="1em" height="1em" viewBox="0 0 24 24" class="stroke-primary fill-theme-primary" data-astro-cid-pjkakwps data-icon="tabler/cpp">  <symbol id="ai:local:tabler/cpp"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"><path stroke="none" d="M0 0h24v24H0z"/><path d="M18 12h4m-2-2v4m-9-2h4m-2-2v4M9 9a3 3 0 0 0-3-3h-.5A3.5 3.5 0 0 0 2 9.5v5A3.5 3.5 0 0 0 5.5 18H6a3 3 0 0 0 3-3"/></g></symbol> <use  xlink:href="#ai:local:tabler/cpp"></use> </svg> compilers </a>  </span> </div>  <div class="prose" data-astro-cid-bvzihdzo> <div class="title" data-astro-cid-bvzihdzo> <span class="date mb-3" data-astro-cid-bvzihdzo> <time datetime="2024-02-05T05:00:00.000Z"> Feb 5, 2024 </time>  </span> <astro-island uid="11lHoh" component-url="/_astro/PostStats.aTcCcsp0.js" component-export="default" renderer-url="/_astro/client.bWR2MAd2.js" props="{&quot;slug&quot;:[0,&quot;ruby-now-produces-machine-code-on-the-fly&quot;],&quot;data-astro-cid-bvzihdzo&quot;:[0,true]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;PostStats&quot;,&quot;value&quot;:true}" await-children=""><span class="emdash" data-svelte-h="svelte-14zf0s3">—</span> <span class="post-stats__views svelte-xfpbcr">0 views</span><!--astro:end--></astro-island> <h1 class="text-3xl" data-astro-cid-bvzihdzo>Ruby now produces machine code on-the-fly</h1> <hr class="not-prose" data-astro-cid-bvzihdzo> </div>  <div class="flex w-full flex-col gap-8 pb-4 transition-all md:flex-row"> <astro-island uid="Zq2pkQ" component-url="/_astro/ZoomImage.wgnhuKA6.js" component-export="default" renderer-url="/_astro/client.bWR2MAd2.js" props="{&quot;src&quot;:[0,&quot;/_astro/yjit.u3rZapDH.png&quot;],&quot;alt&quot;:[0,&quot;An example of very popular sites switching their app entirely over to the new YJIT Ruby.&quot;],&quot;caption&quot;:[0,&quot;An example of very popular sites switching their app entirely over to the new YJIT Ruby.&quot;]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;ZoomImage&quot;,&quot;value&quot;:true}" await-children=""> <button aria-label="Open full-size image"><figure class="my-8 bg-surface rounded-md py-1"><astro-slot> <img src="/_astro/yjit.u3rZapDH_J6EMR.webp" srcset="/_astro/yjit.u3rZapDH_2rxsHx.webp 240w, /_astro/yjit.u3rZapDH_vDqjC.webp 540w, /_astro/yjit.u3rZapDH_Z2wtT5E.webp 720w, /_astro/yjit.u3rZapDH_J6EMR.webp 768w" sizes="(max-width: 360px) 240px, (max-width: 720px) 540px, (max-width: 1600px) 720px, 768px" alt="An example of very popular sites switching their app entirely over to the new YJIT Ruby." width="768" height="663" loading="lazy" decoding="async"> </astro-slot> <article class="prose text-center max-w-content mb-2 prose-gray text-base italic"><figcaption>An example of very popular sites switching their app entirely over to the new YJIT Ruby.</figcaption></article></figure></button> <dialog class="p-3 animate-dialog-in animate-dialog-out svelte-fu0dbb  bg-gray-50"><button class="absolute top-0 right-0 p-2 border border-radius-md bg-gray-100 border-color-gray-300 border-1 w-8 h-8 text-gray-400 hover:text-red-400 text-base font-bold leading-5" aria-label="Close" data-svelte-h="svelte-5ya9si">X</button> <figure class="bg-surface rounded-md py-1"><img src="/_astro/yjit.u3rZapDH.png" alt="An example of very popular sites switching their app entirely over to the new YJIT Ruby." class="svelte-fu0dbb"> <article class="prose text-center max-w-content mb-2 prose-gray"><figcaption>An example of very popular sites switching their app entirely over to the new YJIT Ruby.</figcaption></article></figure> </dialog><!--astro:end--></astro-island> </div> <p>Generate a blog post discussing how YJIT ruby works, what BBV (Basic block versioning) is, and how it relates to YJIT. Also discuss how shopify has contributed object shapes to ruby’s internal object representation. Finally, discuss how shopify has contributed to Ruby’s garbage compiler. All of these contributions have greatly increased the robustness of Ruby. The audience of the blog post is other Ruby on Rails developers that aren’t familiar with how JIT compilers work.</p>
<h1 id="ruby-now-produces-machine-code-on-the-fly">Ruby now produces machine code on-the-fly</h1>
<p>This is also known as a JIT compiler.</p>
<p>In the spectrum of software technologies, Just-In-Time (JIT) compilers have emerged as invaluable tools that effectively optimize runtime performance. Ruby, a dynamic, interpretative language, has certainly benefited from JIT architectures. Notably, YJIT, an optimizing JIT compiler built inside CRuby (now built with Rust), has been pivotal in enhancing Ruby’s robustness and performance. If you’re a Ruby on Rails developer interested in JIT compilers but unfamiliar with their workings, you’ve come to the right place.</p>
<h2 id="understanding-yjit-in-ruby">Understanding YJIT in Ruby</h2>
<p>Incorporated officially as part of Ruby 3.1 and 3.2, YJIT has immeasurably improved Ruby’s speed, making it 57% faster (<a href="https://shopify.engineering/ruby-yjit-is-production-ready">source</a>). Its lightweight nature and minimalistic design provide a great deal of value with less memory usage (although that is its biggest weakness [3]), increasing the language’s overall efficiency.</p>
<p>YJIT operates on a Basic Block Versioning (BBV) approach, a JIT architecture that lazily compiles code (<a href="https://docs.ruby-lang.org/en/master/yjit/yjit_md.html">source</a>). But, what does lazy compilation or BBV mean? Let’s delve into that.</p>
<p>Basic Block Versioning (BBV) is a strategy used in Just-In-Time (JIT) compilers, including those for Ruby, to achieve high-performance machine code generation. BBV takes advantage of dynamic programming language features by generating type-specialized machine code on-the-fly, without undergoing separate type analysis or speculative optimization phases. This capability avoids both the precision limitations of traditional type analysis and the complexity associated with speculative optimization techniques <a href="https://arxiv.org/pdf/1507.02437.pdf">source</a>.</p>
<p>Lazy Basic Block Versioning (LBBV), an application of BBV, allows the execution of the program itself to dictate the generation of type-specialized code <a href="https://arxiv.org/pdf/1411.0352v1">source</a>.</p>
<p>To illustrate, consider a code block in Ruby where a variable ‘num’ might be an integer or a floating-point number:</p>
<pre class="shiki shaku material-theme-darker" style="color:#EEFFFF;background-color:#212121"><div class="code-container"><code><div class="line"></div><div class="line"><span style="color:#89DDFF">def</span><span style="color:#EEFFFF"> </span><span style="color:#82AAFF">calculate</span><span style="color:#89DDFF">(</span><span style="color:#EEFFFF">num</span><span style="color:#89DDFF">)</span></div><div class="line"></div><div class="line"><span style="color:#EEFFFF">    </span><span style="color:#89DDFF">return</span><span style="color:#EEFFFF"> num </span><span style="color:#89DDFF">*</span><span style="color:#EEFFFF"> </span><span style="color:#F78C6C">2</span></div><div class="line"></div><div class="line"><span style="color:#89DDFF">end</span></div><div class="line"></div></code></div></pre>
<p>During execution, the JIT compiler would create two versions of this basic code block. First, if ‘num’ is an integer during a particular execution, the compiler generates and caches a version optimized for handling integers. Second, if ‘num’ is a floating-point number in another execution, the compiler produces a separate version optimized for floating-point computations. Therefore, depending on the type of ‘num’, the JIT compiler selects the matching optimized block for execution.</p>
<p>This way, BBV delivers optimized performance since the JIT compiler generates and uses machine code customized for specific data types based on actual execution patterns, rather than making assumptions or using overly generalized code <a href="https://www-labs.iro.umontreal.ca/~feeley/papers/SaleilFeeleyVMIL18.pdf">source</a>.</p>
<hr/>
<h2 id="basic-block-versioning-bbv-and-yjit">Basic Block Versioning (BBV) and YJIT</h2>
<p>BBV in YJIT plays a crucial role in enhancing Ruby’s performance. In essence, a basic block is a sequence of instructions with a single entry and exit points. “Versioning” of these blocks allows YJIT to accumulate and propagate type information, which is vital for optimizing dynamically-typed languages like Ruby. The versions of a basic block accommodate different execution paths and scenarios, resulting in highly flexible and efficient code execution.</p>
<h2 id="shopifys-influential-contributions">Shopify’s Influential Contributions</h2>
<p>Shopify, a major player in the Ruby community, has been influential in augmenting Ruby’s internal object representation. Shopify’s contributions to “object shapes”, which capture the layout of an object’s attributes and types, have been pertinent in enhancing Ruby’s efficiency. Shopify’s insights into leveraging object shapes have provided a framework for improving the performance of object-oriented programming in Ruby (<a href="https://rubykaigi.org/2021-takeout/data/slides/Maxime-YJIT-RubyKaigi-2021-slides.pdf">source</a>).</p>
<p>Furthermore, Shopify has significantly contributed to Ruby’s garbage compiler. Although the granular specifics of these modifications aren’t readily available, the collective endeavor of these contributions has been shown to enhance Ruby’s robustness, making YJIT even more viable for real-world production deployments (<a href="https://rubykaigi.org/2023/presentations/maximecb.html">source</a>).</p>
<h2 id="embracing-the-future-with-yjit">Embracing the Future with YJIT</h2>
<p>In a nutshell, YJIT and the underlying BBV concept, combined with Shopify’s pivotal contributions, have played vital roles in improving Ruby’s robustness and performance. This intricate interplay of architectures, techniques, and contributions, although technical in nature, holds practical implications for us, the developers. As we continue to improve our code and optimize our applications, understanding these underlying principles better equips us for the journey. With firms like Shopify actively pushing boundaries, we can look forward to further exciting enhancements in Ruby’s future.</p>
<p>References:</p>
<ul>
<li>
<p><a href="https://shopify.engineering/ruby-yjit-is-production-ready">Shopify Engineering</a></p>
</li>
<li>
<p><a href="https://docs.ruby-lang.org/en/master/yjit/yjit_md.html">Ruby Official Documentation</a></p>
</li>
<li>
<p><a href="https://github.com/Shopify/yjit">Shopify YJIT GitHub Repo</a></p>
</li>
<li>
<p><a href="https://rubykaigi.org/2021-takeout/data/slides/Maxime-YJIT-RubyKaigi-2021-slides.pdf">RubyKaigi 2021</a></p>
</li>
<li>
<p><a href="https://rubykaigi.org/2023/presentations/maximecb.html">RubyKaigi 2023</a></p>
</li>
</ul>  <a data-back-to-top data-astro-cid-bvzihdzo class="[&#38;_svg]:fill-theme-amethyst-100; align-middle text-sm text-amethyst-800 no-underline underline-offset-4 hover:text-amethyst-900 hover:no-underline [&#38;:hover_svg]:bg-amethyst-200 [&#38;:hover_svg]:stroke-amethyst-500 [&#38;:hover_svg]:text-amethyst-500 [&#38;_hover_span]:underline [&#38;_span]:underline [&#38;_svg]:bg-amethyst-100"> <span class="underline underline-offset-4">Back to top</span> <svg width="1em" height="1em" viewBox="0 0 24 24" class="inline-block" data-icon="tabler/chevron-up">  <symbol id="ai:local:tabler/chevron-up"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"><path stroke="none" d="M0 0h24v24H0z"/><path d="m6 15 6-6 6 6"/></g></symbol> <use  xlink:href="#ai:local:tabler/chevron-up"></use> </svg> </a> </div> </div> </div> </div>  </article>  </div> </main> <footer data-astro-cid-sz7xmlte> <div class="max-w-3xl" data-astro-cid-sz7xmlte>
&copy; 2024 Aaron Lifton. All rights reserved.
<div class="social-links" data-astro-cid-sz7xmlte> <a href="https://linkedin.com/aaronlifton" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Are you a recruiter? Connect with Aaron on LinkedIn</span> <svg width="32" height="32" viewBox="0 0 24 24" data-astro-cid-sz7xmlte data-icon="linkedin">   <use  xlink:href="#ai:local:linkedin"></use> </svg> </a> <a href="https://github.com/aaronlifton" target="_blank" data-astro-cid-sz7xmlte> <span class="sr-only" data-astro-cid-sz7xmlte>Go to Aaron's Github page</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" astro-icon="social/github" data-astro-cid-sz7xmlte><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-sz7xmlte></path></svg> </a> </div> </div> </footer>  </body></html>  