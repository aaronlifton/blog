---
import ZoomImage from "$components/ZoomImage.svelte";
import BlogPost from "$layouts/BlogPost.astro";
import { Image } from "astro:assets";
import { type CollectionEntry, getCollection } from "astro:content";

export const prerender = true;
export async function getStaticPaths() {
  const posts = await getCollection("blog");
  return posts
    .filter((post) => !post.data.draft)
    .map((post) => ({
      params: { slug: post.slug },
      props: post,
    }));
}
type Props = CollectionEntry<"blog">;

const post = Astro.props;
const { Content, headings, remarkPluginFrontmatter } = await post.render();

let width = post.data.cover.width;
let height = post.data.cover.height;
if (post.data.cover.width > 1000) {
  width /= 2;
  height /= 2;
}
---

<BlogPost {...post.data} {headings} {remarkPluginFrontmatter}>
  <div class="flex flex-col gap-8 pb-4 w-full transition-all md:flex-row">
    <Image
      id={`img-${post.slug}`}
      class="my-4"
      src={post.data.cover}
      width={1500}
      height={643}
      alt={post.data.coverAlt}
      loading="lazy"
      decoding="async"
      format="webp"
      transition:name={`img-${post.slug}`}
    />
    {
      false && (
        <ZoomImage
          src={post.data.cover.src}
          alt={post.data.coverAlt}
          caption={post.data.coverAlt}
          client:load
        >
          <Image
            src={post.data.cover}
            {width}
            {height}
            alt={post.data.coverAlt}
          />
        </ZoomImage>
      )
    }
  </div>
  <Content />
</BlogPost>

<script define:vars={{ post }}>
let dialogEl: HTMLDialogElement | null;
let imgClickEvent;
document.addEventListener("astro:after-swap", () => {
  imgClickEvent = document.getElementById(`img-${post.slug}`).addEventListener(
    "click",
    () => {
      // TODO: after installing shadcn, trigger dialog
    },
  );
});
</script>
