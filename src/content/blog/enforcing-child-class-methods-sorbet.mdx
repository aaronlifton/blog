---
title: "Enforcing child class methods with Sorbet"
description: "Enforcing child class methods with Sorbet"
pubDate: "Apr 23 2024"
cover: ./assets/screenshots/nvim-trpc-router.png
coverAlt: "todo"
tags: ["rails"]
draft: false
featured: true
---

One error you might encounter with Sorbet, a static type-checker for Ruby, is a
**dynamic constant reference** error: Sorbet does not support dynamic constants,
and instead any "existence checks" for methods or constants in subclasses should
be replaced with a _type constraint_. Below is an example of this type of error.
In this example, we have a `Transaction` class that has a dynamic constant
reference in its `min_amount` method, meant to enforce the existence of this
constant on its sub-classes.

```ruby
class Transaction < ApplicationRecord
  MIN_AMOUNT = 100

  def min_amount
    self::class::MIN_AMOUNT || raise("Min amount constant not found)
  end
```

```ruby
models/bar.rb:24: Dynamic constant references are unsupported https://srb.help/5001
24 |      self.class::MIN_AMOUNT
```

There's 2 issues here: First, it's better to move the minimum amount value into
a method named `default_amount` because Sorbet doesn't support this kind of
dynamic constant lookup, and second, moving the value into a method allows us to
take advantage of annotating it with Sorbet so that child classes need not raise
an error: child classes would not pass validation if they are missing an
implementation of a abstract method.

We can mark a method on the parent class as abstract via the `sig{abstract}`
signature. This type signature means that all subclasses must implement the
abstract method. This also does away with a pattern I've seen in many projects,
which is raising an error in a subclass if something isn't implemented. Instead,
we can use Sorbet instead to describe a method as an abstract method that
returns a specific type, and that all subclass must respect that signature as
well. requires that child classes implement the method, rather than raise a
runtime error. We can rely on Sorbet's static type checking than to use an error
to enforce a constant:

```ruby
# typed: true
class Transaction < ApplicationRecord
  extend T::Sig
  extend T::Helpers
  abstract!

  sig{abstract.returns(Integer)}
  def min_amount
    100
  end
end
```

This enforces the presence of `min_amount` on any subclass of Transaction:

```ruby
# typed: true

class Transaction
  extend T::Sig
  extend T::Helpers
  abstract!

  sig{abstract.returns(Integer)}
  def min_amount
  end
end



# This will not compile, as it is missing `min_amount`
class Bulk < Transaction
end
```

This raises the following sorbet error, as `Transaction::Bulk` is missing a
definition for `min_amount`.

```ruby
transaction.rb:12: Missing definition for abstract method Transaction#min_amount https://srb.help/5023
    12 |class Bulk < Transaction
        ^^^^^^^^^^^^^^^^^^^^^^^^
    editor.rb:8: min_amount defined here
     8 |  def min_amount
          ^^^^^^^^^^^^^^
  Autocorrect: Use -a to autocorrect
    editor.rb:13: Insert sig { override.returns(Integer) }
      def min_amount; end
    13 |end
        ^
Errors: 1
```

```lua
return {
  {
    "neovim/nvim-lspconfig",
    opts = {
      servers = {
        -- example of a ruby-lsp based configuration, no need for rubocop ls
        ruby_ls = {},
        solargraph = {}
        yamlls = {}
        sorbet = {}
      },
      setup = {
        sorbet = function()
        local function sorbet_root_pattern(...)
          local patterns = { "sorbet/config" }
          return require("lspconfig.util").root_pattern(unpack(patterns))(...)
        end

        require("lspconfig").sorbet.setup({
          cmd = { "srb", "tc", "--lsp" },
          filetypes = { "ruby" },
          root_dir = function(fname)
            return sorbet_root_pattern(fname)
          end,
        })
      end
      }
    }
  }
}
```

The following flags for `srb` may be of use to you:
`--typed true --enable-all-experimental-lsp-features --lsp --disable-watchman`

Running sorbet as a language server works best with watchman, according to the
[docs](https://sorbet.org/docs/lsp). To run sorbet with watchman, just make sure
it is installed; on OSX it is available via brew: `brew install watchman`, and
on other platforms refer to the offical
[docs](https://facebook.github.io/watchman/docs/install).
