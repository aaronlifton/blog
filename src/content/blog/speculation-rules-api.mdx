---
title: Speculation rules API
description:
  How to use the speculation rules API to create a custom speculative parser for
  your website.
pubDate: Mar 14 2024
cover: ./assets/speculation-rules.png
coverAlt:
  Speculation rules can be seen in the new 'Preloading' section of Chrome
  Developer Tools
tags: [web-standards, speculation-rules]
draft: true
---

In the modern web development landscape, page loading speed is integral to user
experience. any web application. Speculation Rules API, an experimental feature,
is pretty much a game changer, as page loads will become instant as the client
fetches them, based on pre-configured rules. This post is intended to guide
developers through the process of integrating the Speculation Rules API with
AstroJS.

## Prerendering with Speculation Rules API

Prerendering is a technique used by browsers to load a document before it's
needed, such as while hovering over a link. The Speculation Rules API enhances
this by allowing you to **prefetch** and actually **prerender** the next page
navigation. While this may create extra work, given that a user may not actually
click on a link after hovering over it, with today's CPUs and network speeds,
this shouldn't be a problem.

With the Speculation Rules API, speculation rules are taken in the form of a
JSON structure that determines what resources should be prefetched or
prerendered by the browser. So, we can define rules in which certain URLs are
dynamically prefetched or prerendered based on user interaction.

Here's an example of speculation rules based on a user's favorites. This would
save CPU cycles, as a user may be more likely to browse their favorites.

```html
<script type="javascript">
  const session = Session.current()
  const userFavorites = API.Brands.favorites({user}).sortBy((brandA) =>
    brandA.viewCount - brandB.viewCount
  )
</script>
<script type="speculationrules">

  {

    "prerender": [

      {"source": "list", "urls": userFavorites.slice(10)}

    ]

  }
</script>
```

## Integration of Speculation Rules API with AstroJS

AstroJS enables you to pre-render your prefetched pages on the client in
supported browsers\[^5^\]. Additionally, AstroJS overrides the standard prefetch
behavior, globally applying the Speculation Rules API to prerender links on the
client\[^4^\].

This is done by configuring the `astro.config.mjs` file\[^4^\]. Once you include
desired `prefetch` configurations in this file, the experimental Speculation
Rules API kicks in, preparing the page for quicker—sometimes instant—page
loads\[^2^\]. Here's how to enable this in the Astro configuration:

```javascript
{
  prefetch: {
    prefetchAll: true,
    defaultStrategy: 'viewport',
  },
  experimental: {
    clientPrerender: true,
  },
}
```

\
Note that before implementing this, you should review the possible risks when prerendering
on the client[^fn1]. Debugging speculation rules can be tricky, particularly for
prerendered pages[^fn2]. However, Chrome provides developer tools with the `performance.getEntriesByType('navigation')[0].activationStart`
function that allows you to verify if a page was prerendered[^fn3].

[^fn1]:

[Speculation Rules API - Web APIs](https://developer.mozilla.org/docs/Web/API/Speculation_Rules_API)

[^fn2]:

[Debugging speculation rules | Blog | Chrome for Developers](https://developer.chrome.com/blog/debugging-speculation-rules/)

[^fn3]:

[Speculation Rules – WordPress plugin | WordPress.org](https://wordpress.org/plugins/speculation-rules/)

[^fn4]:

[Prerender pages in Chrome for instant page navigations](https://developer.chrome.com/docs/web-platform/prerender-pages)

[^fn5]:

[Configuration Reference | Docs - Astro Documentation](https://docs.astro.build/en/reference/configuration-reference/)

[^fn16]:

[Astro Islands](https://docs.astro.build/en/concepts/islands/)

```

```
