---
title: "Neovim macros vs normal mode"
description:
  "A discussion on the benefits of using normal mode commands versus macros in
  Neovim."
pubDate: "Apr 1 2024"
cover: "./assets/screenshots/cva-button.jpg"
coverAlt: "Telescope macro extension"
tags: ["react", "tailwind", "css"]
---

import { Code } from "astro:components";
import macroVideo from "./assets/videos/macro.webm";
import macroVideo2 from "./assets/videos/macro2.webm";
import globalVideo from "./assets/videos/global1.webm";

<video controls="" autoplay="" loop="true">
  <source src={macroVideo} type="video/webm" />
</video>

In Neovim, which is better, **macros** or **normal** mode? You may be surprised
at the power of normal mode, and the **execute** command, compared to managing
macros with plugins.

One question you might ask is, if normal mode can perform the same job as
macros, then in which cases would you use macros? Probably when you use them
regularly and in different projects. However, you can do this with
`execute "norm"` commands too, by saving them as keybindings.

## Why normal mode

When using normal mode, You get to practice writing normal commands live, while
looking at the code, rather than try to decipher a dense string of characters
that doesn't make sense in an editable list format, without the original
context. I would say it's better to get good at vim motions and be prepared to
write them at-will rather than spend time writing and organizing macros. Yes,
there are macro plugins that help you organize them, but I found that editing
and remembering which macro was which, was quite cumbersome.

You should note that regardless of how you are recording your commands, is that
it's better to use <kbd>fFtT</kbd> and <kbd>hjkl</kbd> than <kbd>wb</kbd>, since
targeting the beginning of a word is way more recognizable in command form than
contextual word navigation. For example, no on wants to see a macro with
`hhhhhjjkkkjdw`.

## Global commands

One cool trick is to use a `g` _(global)_ command to make a change to every
location of a word in a file. For example, what if we wanted to use a normal
command to ugprade the syntax of an older javascrirpt file? We would execute the
following command:

```vim
:g :g/function /execute "norm cwconst^[f(i = f{i=> "
```

Executing `:g /function /execute "norm cwconst^[f(i = ^[f{i=> ^["` will change
the function syntax to arrow function syntax for all instances of the word
`function`. Note that the `^]` symbols are special - they were inserted via

<kbd>Ctrl-V</kbd> and then <kbd>Esc</kbd>. Note they are purple in the command
box. If `^] is not colored differently`, than it will not work as the special
escape syntax.

<video controls="" autoplay="" loop="true">
  <source src={macroVideo2} type="video/webm" />
</video>

Another trick is the `:g/found/v/notfound/{cmd}` syntax &mdash; in this example,
a command is being run on lines that contain `function`, but _do not_ contain
`test`. This a potentially way to delete all your code but keep your test!
Seriously, don't try this at home.

<video controls="" autoplay="" loop="true">
  <source src={globalVideo} type="video/webm" />
</video>
\

For another example, I ran 2 normal mode commands on the spot, when I was trying
to convert colorspace function-less hsl colors from a shadcn install to oklch. I
have an Apple Studio Display, which makes me really appreciate the brighter
colorspace of oklch.

I also found that recording macros often requires multiple tries, which
distracts you from whatever you're working on. You won't be able to immediately
use the macro, since you will have to go back and edit it. It's better to just
write the normal mode command and use it immediately. Then
typeÂ `let @q='<C-R>q'`Â and then edit the macro inside the quotes. I think it's
better than polluting your buffers.

Additionally, I had made several enjoyable macros, but forgot what they do and
well, deciphering letters takes more time than to just not use the macro.

## Another example

In my [Wezterm] config, I wanted to see if I could replace all instead of
`a.[Wezterm method]` with `act.[Wezterm method]`, where a Wezterm method is a
command available in the wezterm action API, like `wezterm.action.SendKey` or
`wezterm.action.SplitHorizontal`. I could have used find and replace with a
regex string, like `%s/act.[A-Z+]/a.[A-Z+]/g`, but to help solve the normal mode
debate, I tried doing this with a normal mode command.

1. First, I set the "find" register (`@\`) to my search string:

   ```regex
    \ a.[A-Z*]
   ```

1. Then I ran this command:

   ```vim
   :171,$norm nlact^["
   ```

1. Result: `a.AdjustPanelSize` and `a.ActivePaneDirection` have been updated to
   have a prefix of `act.` instead of `a.`, as well as any other methods that
   started with `act.`. Now, the variable `a` can be deleted.

However, it is not easy to deal with the escape characters, and the command is
not very readable. A better solution is to use the `execute` command:

```vim
execute "159,165norm 0fc2dw"
```

This command means, if the cursor was directly below the `*` character below,
running `:execute "2,4norm fc2dw"` would move the cursor to the `c` in `config`
on line 2, and delete the word `config` on lines 2, 3, and 4.

In other words, it would change this:

```lua annotate
  * config.a = 1,
--  ^<
-- [cursor should be here]
    config.b = 2,
    config.c = 3
```

_into this:_

```lua
{a = 1,b = 2,c = 3}
```

\
In Neovim, macros are stored as their actual commands, and in order to add a description
to them, a plugin is needed. This turned out to be more tricky than I had expected,
as this is a case when the most popular plugins on Github are actually not to be
recommended. The first result, [NeoComposer](https://github.com/ecthelionvi/NeoComposer.nvim),
made little sense to use unless you always kept your macro list to at most 7 macros
and you are able to easily decipher all of them. (macros are displayed as virtual
text and you can "scroll" through the macros via <kbd>C-n</kbd> and <kbd>C-p</kbd>.

<video controls="" autoplay="" loop="true">
  <source src={macroVideo} type="video/webm" />
</video>

I considered forking the project but I knew my macro collection would be big
enough to require searching. The next most popular plugin was
[Macrobatics](https://github.com/svermeulen/vim-macrobatics), which looked to be
exactly what I wanted, but I had this need for everything to be using the Neovim
Lua API, and not direct vim commands, and actually the plugin just did not work
on my machine, so I searched Github until i found one that actually worked well
â€” [telescope-macros](https://github.com). Adding a telescope finder is a clever
and simple solution and I applaud the author an editable list is the only thing
needed to manage a macro library.

If I have a macro assigned to the `@l` register, using `telescope-macros`, I can
apply it repeatedly via <kbd>leader->ml</kbd>: <kbd>leader->m</kbd> opens the
telescope macros list, `l` finds the macro under the `@l` register, and `<cr>`
closes the window and applies the macro.

I felt some modifications were essential to make â€” for instance, adding a key
binding to [[â˜† Telescope keymap]] that would close the modal and navigate to the
previewed file. Why isn't that part of telescope by default? I searched for
examples and found none other than [[ThePrimeagen]]'s telescope modifications,
and I took his `get_preview` function, which would open the buffer from the
preview window in the editor.

However, his function didn't work and I punted on the idea after trying and
failing to get AI to help. Later on, I actually found Google Duet to be the most
proficient as writing Neovim functions.
