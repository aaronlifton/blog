---
title: "Using TRPCv11 with Astro"
description: "Learn how to call TRPC endpoints from Astro on the server and on the client "
pubDate: "Mar 24 2024"
cover: "./assets/bad-component.png"
coverAlt: ""
tags: ["react", "trpc", "astro"]
---
# Using tRPC v11.1 with Astro, Prisma, and the Github API

First, install v11 of TRPC. [TRPC v11](https://trpc.io/docs/migrate-from-v10-to-v11) packages have the `@next` release tag, and we can install them as follows:

```sh
npm install @trpc/server@next @trpc/client@next @trpc/react-query@next @trpc/next@next @tanstack/react-query@latest @tanstack/react-query-devtools@latest
```

We will be building a React component that uses Suspense to render a loading
state, while the backend streams data from the Github API. API calls will be
handled by the tRPC server, which will be running on the same server as the Astro server.

This idea came from me writing a deep-dive article on the React codebase, and I wanted to make it
easier to fetch and cache code snippets from Github in other articles.

## Testing the github API with curl

First, let's take a look at what the Github API returns when we request the contents of a file from a repository:

```sh
❯ gh api \
        -H "Accept: application/vnd.github+json" \
        -H "X-GitHub-Api-Version: 2022-11-28" \
        /repos/facebook/react/contents/packages/shared/shallowEqual.js
```

```json
{
  "name": "shallowEqual.js",
  "path": "packages/shared/shallowEqual.js",
  "sha": "7c73b88c05c32ce1e2ff16a51498631939469050",
  "size": 1259,
  "url": "https://api.github.com/repos/facebook/react/contents/packages/shared/shallowEqual.js?ref=main",
  "html_url": "https://github.com/facebook/react/blob/main/packages/shared/shallowEqual.js",
  "git_url": "https://api.github.com/repos/facebook/react/git/blobs/7c73b88c05c32ce1e2ff16a51498631939469050",
  "download_url": "https://raw.githubusercontent.com/facebook/react/main/packages/shared/shallowEqual.js",
  "type": "file",
  "content": "LyoqCiAqIENvcHlyaWdodCAoYykgTWV0YSBQbGF0Zm9ybXMsIEluYy4gYW5k\nIGFmZmlsaWF0ZXMuCiAqCiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5z\nZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZQogKiBMSUNF\nTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNl\nIHRyZWUuCiAqCiAqIEBmbG93CiAqLwoKaW1wb3J0IGlzIGZyb20gJy4vb2Jq\nZWN0SXMnOwppbXBvcnQgaGFzT3duUHJvcGVydHkgZnJvbSAnLi9oYXNPd25Q\ncm9wZXJ0eSc7CgovKioKICogUGVyZm9ybXMgZXF1YWxpdHkgYnkgaXRlcmF0\naW5nIHRocm91Z2gga2V5cyBvbiBhbiBvYmplY3QgYW5kIHJldHVybmluZyBm\nYWxzZQogKiB3aGVuIGFueSBrZXkgaGFzIHZhbHVlcyB3aGljaCBhcmUgbm90\nIHN0cmljdGx5IGVxdWFsIGJldHdlZW4gdGhlIGFyZ3VtZW50cy4KICogUmV0\ndXJucyB0cnVlIHdoZW4gdGhlIHZhbHVlcyBvZiBhbGwga2V5cyBhcmUgc3Ry\naWN0bHkgZXF1YWwuCiAqLwpmdW5jdGlvbiBzaGFsbG93RXF1YWwob2JqQTog\nbWl4ZWQsIG9iakI6IG1peGVkKTogYm9vbGVhbiB7CiAgaWYgKGlzKG9iakEs\nIG9iakIpKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CgogIGlmICgKICAgIHR5\ncGVvZiBvYmpBICE9PSAnb2JqZWN0JyB8fAogICAgb2JqQSA9PT0gbnVsbCB8\nfAogICAgdHlwZW9mIG9iakIgIT09ICdvYmplY3QnIHx8CiAgICBvYmpCID09\nPSBudWxsCiAgKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQoKICBjb25zdCBr\nZXlzQSA9IE9iamVjdC5rZXlzKG9iakEpOwogIGNvbnN0IGtleXNCID0gT2Jq\nZWN0LmtleXMob2JqQik7CgogIGlmIChrZXlzQS5sZW5ndGggIT09IGtleXNC\nLmxlbmd0aCkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KCiAgLy8gVGVzdCBm\nb3IgQSdzIGtleXMgZGlmZmVyZW50IGZyb20gQi4KICBmb3IgKGxldCBpID0g\nMDsgaSA8IGtleXNBLmxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCBjdXJyZW50\nS2V5ID0ga2V5c0FbaV07CiAgICBpZiAoCiAgICAgICFoYXNPd25Qcm9wZXJ0\neS5jYWxsKG9iakIsIGN1cnJlbnRLZXkpIHx8CiAgICAgIC8vICRGbG93Rml4\nTWVbaW5jb21wYXRpYmxlLXVzZV0gbG9zdCByZWZpbmVtZW50IG9mIGBvYmpC\nYAogICAgICAhaXMob2JqQVtjdXJyZW50S2V5XSwgb2JqQltjdXJyZW50S2V5\nXSkKICAgICkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfQoKICBy\nZXR1cm4gdHJ1ZTsKfQoKZXhwb3J0IGRlZmF1bHQgc2hhbGxvd0VxdWFsOwo=\n",
  "encoding": "base64",
  "_links": {
    "self": "https://api.github.com/repos/facebook/react/contents/packages/shared/shallowEqual.js?ref=main",
    "git": "https://api.github.com/repos/facebook/react/git/blobs/7c73b88c05c32ce1e2ff16a51498631939469050",
    "html": "https://github.com/facebook/react/blob/main/packages/shared/shallowEqual.js"
  }
}
```

For this exercise, we'll be using TRPC, so let's set that up first.

1. Create a new folder called `rpc-server` in the root of the project.

Next, we're going to set up the "context" for our RPC requests.
Inner context is where you define context which doesn’t depend on the request, e.g. your database connection. You can use this function for integration testing or server-side helpers, where you don’t have a request object.
Inner context is always available in your procedures, while outer context is context which definition is dependent on the request.
This is useful for things like authentication, for information about the user's session would be available in the request.
This kind of context is only available for procederues that are called via HTTP.

2. Create a file named 'context.ts' in the `rpc-server` folder:

```ts
import prisma from "$services/db";
import type { FetchCreateContextFnOptions } from "@trpc/server/adapters/fetch";
// import type { CreateNextContextOptions } from '@trpc/server/adapters/next';

interface CreateInnerContextOptions
 extends Partial<FetchCreateContextFnOptions> {}
/**
 * Inner context. Will always be available in your procedures, in contrast to the outer context.
 * For example, if we use prisma as our ORM, we could store that in our inner
 context.
 * Also useful for:
 * - testing, so you don't have to mock Next.js' `req`/`res`
 * - tRPC's `createServerSideHelpers` where we don't have `req`/`res`
 *
 * @link https://trpc.io/docs/v11/context#inner-and-outer-context
 */
export async function createContextInner(opts?: CreateInnerContextOptions) {
 return {
   prisma,
 };
}

export async function createContext({
  req,
  resHeaders,
}: FetchCreateContextFnOptions) {
 const contextInner = await createContextInner({});
 return { ...contextInner, req: req, resHeaders: resHeaders };
}
export type Context = Awaited<ReturnType<typeof createContext>>;
```

2. Create a file named 'server.ts' in the `rpc-server` folder:

```ts
import { initTRPC } from "@trpc/server";
import { createHTTPServer } from "@trpc/server/adapters/standalone";
import { appRouter } from "./router.ts";
import { createContext } from "./context.ts";
import cors from "cors";

createHTTPServer({
 middleware: cors(),
 router: appRouter,
 createContext,
}).listen(3333);
```

Let's start by creating a new endpoint in the `api/ops` folder that fetches the contents of a file from a GitHub repository:

```ts

There's a lot of data here, but the most important part is the `data` object, which contains the *base64-encoded* file contents of the file we requested.


## Testing the server side call

Now that we've finally hooked everything up to be able to make RPC calls from the server, let's test the `getRepoContents` endpoint:

```json
{
  body: {
    status: 200,
    url: 'https://api.github.com/repos/facebook/react/contents/packages%2Fshared%2FshallowEqual.js',
    headers: {
      // ...
      'access-control-allow-origin': '*',
      'cache-control': 'public, max-age=60, s-maxage=60',
      'content-length': '1340',
      'content-security-policy': "default-src 'none'",
      server: 'GitHub.com',
      'x-content-type-options': 'nosniff',
      'x-frame-options': 'deny',
      'x-github-api-version-selected': '2022-11-28',
      'x-github-media-type': 'github.v3; format=json',
      'x-github-request-id': '...',
      'x-ratelimit-limit': '60',
      'x-ratelimit-remaining': '59',
      'x-ratelimit-reset': '1711322225',
      'x-ratelimit-resource': 'core',
      'x-ratelimit-used': '1',
      'x-xss-protection': '0'
    },
    data: {
      name: 'shallowEqual.js',
      path: 'packages/shared/shallowEqual.js',
      sha: '7c73b88c05c32ce1e2ff16a51498631939469050',
      size: 1259,
      url: 'https://api.github.com/repos/facebook/react/contents/packages/shared/shallowEqual.js?ref=main',
      html_url: 'https://github.com/facebook/react/blob/main/packages/shared/shallowEqual.js',
      git_url: 'https://api.github.com/repos/facebook/react/git/blobs/7c73b88c05c32ce1e2ff16a51498631939469050',
      download_url: 'https://raw.githubusercontent.com/facebook/react/main/packages/shared/shallowEqual.js',
      type: 'file',
      content: 'LyoqCiAqIENvcHlyaWdodCAoYykgTWV0YSBQbGF0Zm9ybXMsIEluYy4gYW5k\n' +
        'IGFmZmlsaWF0ZXMuCiAqCiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5z\n' +
        'ZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZQogKiBMSUNF\n' +
        'TlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNl\n' +
        'IHRyZWUuCiAqCiAqIEBmbG93CiAqLwoKaW1wb3J0IGlzIGZyb20gJy4vb2Jq\n' +
        'ZWN0SXMnOwppbXBvcnQgaGFzT3duUHJvcGVydHkgZnJvbSAnLi9oYXNPd25Q\n' +
        'cm9wZXJ0eSc7CgovKioKICogUGVyZm9ybXMgZXF1YWxpdHkgYnkgaXRlcmF0\n' +
        'aW5nIHRocm91Z2gga2V5cyBvbiBhbiBvYmplY3QgYW5kIHJldHVybmluZyBm\n' +
        'YWxzZQogKiB3aGVuIGFueSBrZXkgaGFzIHZhbHVlcyB3aGljaCBhcmUgbm90\n' +
        'IHN0cmljdGx5IGVxdWFsIGJldHdlZW4gdGhlIGFyZ3VtZW50cy4KICogUmV0\n' +
        'dXJucyB0cnVlIHdoZW4gdGhlIHZhbHVlcyBvZiBhbGwga2V5cyBhcmUgc3Ry\n' +
        'aWN0bHkgZXF1YWwuCiAqLwpmdW5jdGlvbiBzaGFsbG93RXF1YWwob2JqQTog\n' +
        'bWl4ZWQsIG9iakI6IG1peGVkKTogYm9vbGVhbiB7CiAgaWYgKGlzKG9iakEs\n' +
        'IG9iakIpKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CgogIGlmICgKICAgIHR5\n' +
        'cGVvZiBvYmpBICE9PSAnb2JqZWN0JyB8fAogICAgb2JqQSA9PT0gbnVsbCB8\n' +
        'fAogICAgdHlwZW9mIG9iakIgIT09ICdvYmplY3QnIHx8CiAgICBvYmpCID09\n' +
        'PSBudWxsCiAgKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQoKICBjb25zdCBr\n' +
        'ZXlzQSA9IE9iamVjdC5rZXlzKG9iakEpOwogIGNvbnN0IGtleXNCID0gT2Jq\n' +
        'ZWN0LmtleXMob2JqQik7CgogIGlmIChrZXlzQS5sZW5ndGggIT09IGtleXNC\n' +
        'Lmxlbmd0aCkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KCiAgLy8gVGVzdCBm\n' +
        'b3IgQSdzIGtleXMgZGlmZmVyZW50IGZyb20gQi4KICBmb3IgKGxldCBpID0g\n' +
        'MDsgaSA8IGtleXNBLmxlbmd0aDsgaSsrKSB7CiAgICBjb25zdCBjdXJyZW50\n' +
        'S2V5ID0ga2V5c0FbaV07CiAgICBpZiAoCiAgICAgICFoYXNPd25Qcm9wZXJ0\n' +
        'eS5jYWxsKG9iakIsIGN1cnJlbnRLZXkpIHx8CiAgICAgIC8vICRGbG93Rml4\n' +
        'TWVbaW5jb21wYXRpYmxlLXVzZV0gbG9zdCByZWZpbmVtZW50IG9mIGBvYmpC\n' +
        'YAogICAgICAhaXMob2JqQVtjdXJyZW50S2V5XSwgb2JqQltjdXJyZW50S2V5\n' +
        'XSkKICAgICkgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfQoKICBy\n' +
        'ZXR1cm4gdHJ1ZTsKfQoKZXhwb3J0IGRlZmF1bHQgc2hhbGxvd0VxdWFsOwo=\n',
      encoding: 'base64',
      _links: [Object]
    }
  }
}
18:17:05 [200] /api/ops/repo-content 385ms
```

As we can see, the endpoint returns base64-encoded content for the file we
requested, along with rate-limit headers that enable developers to prevent
hitting the rate limit.

## Making the Github API call server-side

Let's create a `services` folder in the `rpc-server` folder, and create a
`github.ts` file in that folder:

```ts
async (props: {
 owner: string;
 repo: string;
 path: string;
}) => {
 const { owner, repo, path } = props;
 try {
  const body = await octokit.request(
   "GET /repos/{owner}/{repo}/contents/{path}",
   {
    owner,
    repo,
    path,
    headers: {
     "X-GitHub-Api-Version": "2022-11-28",
    },
   },
  );
  if (body.status !== 200) {
   throw new Error(`Invalid status code: ${body.status}`);
  }
  // sourcery skip: use-object-destructuring
  const rateLimitRemaing = body.headers["x-ratelimit-remaining"];
  const rateLimitReset = body.headers["x-ratelimit-reset"];

  const data = body.data;
    // TODO: handle rate limit headers and parse data
 } catch (error) {
  console.error(error);
  return new Response(JSON.stringify({ error }), { status: 500 });
 }
}```

Regarding the rate limit headers, github gives us the number of requests we can
have remaining during a give period, as well as when the limit resets.

It's important to keep track of events like rate limit hits, so that we can
better handle, and most importantly, avoid them.
```ts
async (props: {
 owner: string;
 repo: string;
 path: string;
}) => {
 const { owner, repo, path } = props;
 try {
  const body = await octokit.request(
   "GET /repos/{owner}/{repo}/contents/{path}",
   {
    owner,
    repo,
    path,
    headers: {
     "X-GitHub-Api-Version": "2022-11-28",
    },
   },
  );
  if (body.status !== 200) {
   throw new Error(`Invalid status code: ${body.status}`);
  }
  // sourcery skip: use-object-destructuring
  const rateLimitRemaing = body.headers["x-ratelimit-remaining"];
  const rateLimitReset = body.headers["x-ratelimit-reset"];

  const data = body.data;
  if (Array.isArray(data)) {
   throw new Error("No file found");
  }
  // const decodedFileContents = Buffer.from(data.content, "base64").toString();
  // const response = {
  //  decodedFileContents,
  //  git_url: data.git_url,
  //  html_url: data.html_url,
//  download_url: data.download_url,
  // };

  const downloadUrl = data.download_url;
  if (!downloadUrl) {
   throw new Error("No download url found");
  }

  const response = await fetch(downloadUrl);

  if (!response.ok) {
   throw new Error("Failed to download diff");
  }

  const decodedFileContents = await response.text();
  const filePath = nodePath.resolve(`data/${data.path}`);
  const folder = filePath.split("/").slice(0, -1).join("/");
  await fs.mkdir(folder, { recursive: true });
  await fs.writeFile(filePath, decodedFileContents);

  const fileWrittenResponse = {
   path: filePath,
  };
  return new Response(JSON.stringify(fileWrittenResponse));
 } catch (error) {
  console.error(error);
  return new Response(JSON.stringify({ error }), { status: 500 });
 }
}
```
